version: '3.8'

services:
  # Base de données PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: clenzy-postgres-dev
    environment:
      POSTGRES_DB: clenzy_dev
      POSTGRES_USER: clenzy
      POSTGRES_PASSWORD: clenzy123
    ports:
      - "5433:5432"
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clenzy -d clenzy_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      clenzy-network:
        aliases:
          - postgres

  # Cache Redis pour les permissions
  redis:
    image: redis:7-alpine
    container_name: clenzy-redis-dev
    hostname: clenzy-redis
    ports:
      - "6379:6379"
    volumes:
      - ./redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      clenzy-network:
        aliases:
          - clenzy-redis

  # Serveur Keycloak
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.5
    container_name: clenzy-keycloak-dev
    hostname: clenzy-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak_dev
      KC_DB_USERNAME: clenzy
      KC_DB_PASSWORD: clenzy123
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT_BACKCHANNEL: false
      KC_PROXY: edge
      KC_PROXY_ADDRESS_FORWARDING: true
    ports:
      - "8086:8080"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./keycloak/realm-clenzy.json:/opt/keycloak/data/import/realm-clenzy.json
    command: start-dev --import-realm
    networks:
      clenzy-network:
        aliases:
          - clenzy-keycloak

  # Proxy Nginx pour Keycloak (accès interne)
  keycloak-proxy:
    image: nginx:alpine
    container_name: clenzy-keycloak-proxy-dev
    hostname: clenzy-keycloak-proxy
    ports:
      - "8085:8080"
    volumes:
      - ./nginx-keycloak.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      keycloak:
        condition: service_started
    networks:
      clenzy-network:
        aliases:
          - clenzy-keycloak-proxy

  # Backend Spring Boot
  server:
    build:
      context: ../server
      dockerfile: Dockerfile
    container_name: clenzy-server-dev
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/clenzy_dev
      SPRING_DATASOURCE_USERNAME: clenzy
      SPRING_DATASOURCE_PASSWORD: clenzy123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://clenzy-keycloak:8080/realms/clenzy
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://clenzy-keycloak:8080/realms/clenzy/protocol/openid-connect/certs
      KEYCLOAK_TOKEN_URI: http://clenzy-keycloak:8080/realms/clenzy/protocol/openid-connect/token
      KEYCLOAK_LOGOUT_URI: http://clenzy-keycloak:8080/realms/clenzy/protocol/openid-connect/logout
      KEYCLOAK_CLIENT_ID: clenzy-web
      KEYCLOAK_CLIENT_SECRET: your-client-secret-here
      # Configuration Keycloak Admin
      KEYCLOAK_AUTH_SERVER_URL: http://clenzy-keycloak:8080
      KEYCLOAK_REALM: clenzy
      KEYCLOAK_MASTER_REALM: master
      KEYCLOAK_ADMIN_USERNAME: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_ADMIN_CLIENT_ID: admin-cli
      # Utiliser l'admin du realm clenzy pour les opérations
      KEYCLOAK_ADMIN_REALM: clenzy
      # Configuration Redis
      SPRING_REDIS_HOST: clenzy-redis
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: 
      SPRING_REDIS_DATABASE: 0
      SPRING_CLOUD_BOOTSTRAP_ENABLED: true
    ports:
      - "8084:8080"
    volumes:
      - ../server:/workspace
      - ~/.m2:/root/.m2
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      clenzy-network:
        aliases:
          - clenzy-server

  # Frontend React
  frontend:
    build:
      context: ../client
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:8084
        VITE_API_BASE_PATH: /api
        VITE_KEYCLOAK_URL: http://localhost:8086
        VITE_KEYCLOAK_REALM: clenzy
        VITE_KEYCLOAK_CLIENT_ID: clenzy-web
        VITE_APP_NAME: Clenzy
        VITE_APP_VERSION: 1.0.0
    container_name: clenzy-frontend-dev
    ports:
      - "3000:80"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    networks:
      clenzy-network:
        aliases:
          - clenzy-frontend

networks:
  clenzy-network:
    driver: bridge
    name: clenzy-network
