#!/bin/bash
# ===========================================
# Pre-push hook: Interdit le push direct sur production.
# Les merges vers production ne sont autorisees que via PR.
# ===========================================
#
# Workflow attendu :
#   1. Developper sur main (ou feature branch)
#   2. Ouvrir une PR : main → production
#   3. La pipeline CI + tests de performance se declenchent
#   4. Review + approval
#   5. Merge la PR (cree un push sur production → deploy)
#
# Ce hook bloque TOUT push direct sur production.
# Seul le merge via GitHub (PR merge) bypass ce hook car il
# n'est pas execute cote serveur.

PROTECTED_BRANCH="production"

while read local_ref local_sha remote_ref remote_sha; do
    if echo "$remote_ref" | grep -qE "refs/heads/${PROTECTED_BRANCH}$"; then
        echo ""
        echo "  ❌  Push direct sur '${PROTECTED_BRANCH}' interdit."
        echo ""
        echo "  Les merges vers production ne sont autorisees que via Pull Request."
        echo "  La PR declenche les tests de performance et charge obligatoires."
        echo ""
        echo "  Workflow :"
        echo "    1. git push origin main"
        echo "    2. Ouvrir une PR : main → production (sur GitHub)"
        echo "    3. Attendre que CI + perf tests passent"
        echo "    4. Merger la PR apres review"
        echo ""
        echo "  Pour forcer (urgence UNIQUEMENT) : git push --no-verify origin ${PROTECTED_BRANCH}"
        echo ""
        exit 1
    fi
done

exit 0
