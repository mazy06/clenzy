# Configuration optimisée pour la performance et la scalabilité (virtual threads)
spring:
  datasource:
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000
      leak-detection-threshold: 60000
      pool-name: ClenzyHikariPool
      
  jpa:
    hibernate:
      ddl-auto: none
  liquibase:
    enabled: true
      jdbc:
        batch_size: 25
        order_inserts: true
        order_updates: true
        batch_versioned_data: true
      connection:
        provider_disables_autocommit: true
    properties:
      hibernate:
        jdbc:
          batch_size: 25
          order_inserts: true
          order_updates: true
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        generate_statistics: true
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 100
              
  redis:
    lettuce:
      pool:
        max-active: 100
        max-idle: 30
        min-idle: 10
        max-wait: 2000ms
      shutdown-timeout: 200ms
    timeout: 5000ms
    
  cache:
    type: redis
    redis:
      time-to-live: 3600000 # 1 heure
      cache-null-values: false
      
  security:
    oauth2:
      resourceserver:
        jwt:
          cache-ttl: 300s # Cache des clés JWT
          
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,httptrace
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99
      slo:
        http.server.requests: 50ms, 100ms, 200ms, 500ms

server:
  tomcat:
    threads:
      max: 200        # Avec virtual threads, Tomcat utilise les carrier threads
      min-spare: 10   # Les virtual threads sont geres automatiquement
    max-connections: 20000
    accept-count: 200
    connection-timeout: 20000
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

logging:
  level:
    org.hibernate.SQL: warn
    org.hibernate.type.descriptor.sql.BasicBinder: warn
    org.springframework.cache: debug
    com.clenzy: info
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{36} - %msg%n"
