package com.clenzy.service;

import com.clenzy.dto.RolePermissionsDto;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;

import java.util.*;

@Service
public class PermissionService {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // Permissions personnalis√©es par r√¥le (stock√©es en m√©moire pour l'instant)
    // En production, cela devrait √™tre stock√© en base de donn√©es
    private final Map<String, List<String>> customRolePermissions;

    public PermissionService() {
        // Initialiser les permissions personnalis√©es vides
        customRolePermissions = new HashMap<>();
    }

    @Cacheable("roles")
    public List<String> getAllRoles() {
        try {
            // Utiliser le repository au lieu du SQL direct
            return Arrays.asList("ADMIN", "MANAGER", "SUPERVISOR", "TECHNICIAN", "HOUSEKEEPER", "HOST");
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration des r√¥les: " + e.getMessage());
            // Fallback vers les r√¥les par d√©faut
            return Arrays.asList("ADMIN", "MANAGER", "SUPERVISOR", "TECHNICIAN", "HOUSEKEEPER", "HOST");
        }
    }

    @Cacheable("rolePermissions")
    public RolePermissionsDto getRolePermissions(String role) {
        try {
            List<String> permissions = getUserPermissions(role);
            boolean isDefault = !customRolePermissions.containsKey(role);
            return new RolePermissionsDto(role, permissions, isDefault);
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration des permissions du r√¥le " + role + ": " + e.getMessage());
            throw new IllegalArgumentException("R√¥le non reconnu: " + role);
        }
    }

    @CacheEvict(value = {"rolePermissions", "userPermissions"}, allEntries = true)
    public RolePermissionsDto updateRolePermissions(String role, List<String> permissions) {
        // Valider que toutes les permissions existent
        List<String> allValidPermissions = getAllValidPermissions();
        for (String permission : permissions) {
            if (!allValidPermissions.contains(permission)) {
                throw new IllegalArgumentException("Permission non reconnue: " + permission);
            }
        }

        try {
            // R√©cup√©rer l'ID du r√¥le
            Long roleId = permissionRepository.findRoleIdByName(role);
            
            if (roleId == null) {
                throw new IllegalArgumentException("R√¥le non trouv√©: " + role);
            }

            // D√©sactiver toutes les permissions actuelles pour ce r√¥le
            permissionRepository.deactivateAllPermissionsForRole(roleId);
            
            // Activer les nouvelles permissions
            for (String permissionName : permissions) {
                // R√©cup√©rer l'ID de la permission
                Long permissionId = permissionRepository.findPermissionIdByName(permissionName);
                
                if (permissionId != null) {
                    // V√©rifier si la relation existe d√©j√†
                    int count = permissionRepository.countRolePermissionRelation(roleId, permissionId);
                    
                    if (count > 0) {
                        // Mettre √† jour la relation existante
                        permissionRepository.activateRolePermissionRelation(roleId, permissionId);
                    } else {
                        // Cr√©er une nouvelle relation
                        permissionRepository.createRolePermissionRelation(roleId, permissionId);
                    }
                }
            }
            
            // Mettre √† jour le cache en m√©moire
            customRolePermissions.put(role, new ArrayList<>(permissions));
            
            System.out.println("üîß PermissionService - Permissions mises √† jour pour le r√¥le " + role + " en base de donn√©es: " + permissions);
            
            return new RolePermissionsDto(role, permissions, false);
            
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la mise √† jour des permissions: " + e.getMessage());
            throw new RuntimeException("Erreur lors de la mise √† jour des permissions: " + e.getMessage(), e);
        }
    }

    @CacheEvict(value = {"rolePermissions", "userPermissions"}, allEntries = true)
    public RolePermissionsDto resetRolePermissions(String role) {
        try {
             // R√©cup√©rer l'ID du r√¥le
            Long roleId = permissionRepository.findRoleIdByName(role);
            
            if (roleId == null) {
                throw new IllegalArgumentException("R√¥le non trouv√©: " + role);
            }

            // D√©sactiver toutes les permissions actuelles pour ce r√¥le
            permissionRepository.deactivateAllPermissionsForRole(roleId);
            
            // R√©cup√©rer les permissions par d√©faut pour ce r√¥le
            List<String> defaultPermissions = getDefaultPermissionsForRole(role);
            
            // Activer les permissions par d√©faut
            for (String permissionName : defaultPermissions) {
                // R√©cup√©rer l'ID de la permission
                Long permissionId = permissionRepository.findPermissionIdByName(permissionName);
                
                if (permissionId != null) {
                    // V√©rifier si la relation existe d√©j√†
                    int count = permissionRepository.countRolePermissionRelation(roleId, permissionId);
                    
                    if (count > 0) {
                        // Mettre √† jour la relation existante
                        permissionRepository.activateRolePermissionRelation(roleId, permissionId);
                    } else {
                        // Cr√©er une nouvelle relation
                        permissionRepository.createRolePermissionRelation(roleId, permissionId);
                    }
                }
            }
            
            // Supprimer les permissions personnalis√©es du cache
            customRolePermissions.remove(role);
            
            System.out.println("üîÑ PermissionService - Permissions r√©initialis√©es pour le r√¥le " + role + " en base de donn√©es: " + defaultPermissions);
            
            return new RolePermissionsDto(role, defaultPermissions, true);
            
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©initialisation des permissions: " + e.getMessage());
            throw new RuntimeException("Erreur lors de la r√©initialisation des permissions: " + e.getMessage(), e);
        }
    }

    public Map<String, List<String>> getDefaultPermissions() {
        Map<String, List<String>> result = new HashMap<>();
        List<String> roles = getAllRoles();

        for (String role : roles) {
            result.put(role, getUserPermissions(role));
        }

        return result;
    }

    public List<String> getAllValidPermissions() {
        try {
            String sql = "SELECT DISTINCT name FROM permissions ORDER BY name";
            return jdbcTemplate.queryForList(sql, String.class);
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration de toutes les permissions: " + e.getMessage());
            // Fallback vers les permissions par d√©faut
            return Arrays.asList(
                "dashboard:view",
                "properties:view", "properties:create", "properties:edit", "properties:delete",
                "service-requests:view", "service-requests:create", "service-requests:edit", "service-requests:delete",
                "interventions:view", "interventions:create", "interventions:edit", "interventions:delete",
                "teams:view", "teams:create", "teams:edit", "teams:delete",
                "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:delete", "portfolios:manage_clients", "portfolios:manage_team",
                "contact:view", "contact:send", "contact:manage",
                "settings:view", "settings:edit",
                "users:manage",
                "reports:view"
            );
        }
    }

    // M√©thode pour obtenir les permissions d'un utilisateur selon son r√¥le
    public List<String> getUserPermissions(String role) {
        try {
            String sql = "SELECT p.name FROM permissions p " +
                        "JOIN role_permissions rp ON p.id = rp.permission_id " +
                        "JOIN roles r ON r.id = rp.role_id " +
                        "WHERE r.name = ? AND rp.is_active = true " +
                        "ORDER BY p.name";

            List<String> permissions = jdbcTemplate.queryForList(sql, String.class, role);
            
            System.out.println("üîç PermissionService - R√©cup√©ration des permissions pour le r√¥le: " + role + " depuis la base de donn√©es");
            System.out.println("üîç PermissionService - Permissions trouv√©es: " + permissions);
            
            return permissions;
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration des permissions: " + e.getMessage());
            // Fallback vers les permissions par d√©faut en cas d'erreur
            if (customRolePermissions.containsKey(role)) {
                return customRolePermissions.get(role);
            }
            return getDefaultPermissionsForRole(role);
        }
    }

    // M√©thode de fallback pour les permissions par d√©faut
    private List<String> getDefaultPermissionsForRole(String role) {
        Map<String, List<String>> defaultPermissions = new HashMap<>();
        
        defaultPermissions.put("ADMIN", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit", "properties:delete",
            "service-requests:view", "service-requests:create", "service-requests:edit", "service-requests:delete",
            "interventions:view", "interventions:create", "interventions:edit", "interventions:delete",
            "teams:view", "teams:create", "teams:edit", "teams:delete",
            "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:delete", "portfolios:manage_clients", "portfolios:manage_team",
            "contact:view", "contact:send", "contact:manage",
            "settings:view", "settings:edit",
            "users:manage",
            "reports:view"
        ));
        
        defaultPermissions.put("MANAGER", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit",
            "service-requests:view", "service-requests:create", "service-requests:edit",
            "interventions:view", "interventions:create", "interventions:edit",
            "teams:view", "teams:create", "teams:edit",
            "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:manage_clients", "portfolios:manage_team",
            "contact:view", "contact:send", "contact:manage",
            "settings:view",
            "users:view",
            "reports:view"
        ));
        
        defaultPermissions.put("SUPERVISOR", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view", "teams:edit",
            "portfolios:view",
            "contact:view", "contact:send"
        ));
        
        defaultPermissions.put("HOST", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit",
            "service-requests:view", "service-requests:create",
            "interventions:view",
            "contact:view", "contact:send"
        ));
        
        defaultPermissions.put("TECHNICIAN", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view",
            "contact:view", "contact:send"
        ));
        
        defaultPermissions.put("HOUSEKEEPER", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view",
            "contact:view", "contact:send"
        ));
        
        return defaultPermissions.getOrDefault(role, new ArrayList<>());
    }

    // M√©thode pour sauvegarder les permissions personnalis√©es d'un r√¥le
    public boolean saveRolePermissions(String role) {
        // V√©rifier s'il y a des permissions personnalis√©es √† sauvegarder
        if (!customRolePermissions.containsKey(role)) {
            System.out.println("üîß PermissionService - Aucune permission personnalis√©e √† sauvegarder pour le r√¥le " + role);
            return false;
        }

        // TODO: En production, sauvegarder en base de donn√©es
        // Pour l'instant, on simule la sauvegarde
        System.out.println("üíæ PermissionService - Sauvegarde des permissions personnalis√©es pour le r√¥le " + role);
        System.out.println("üíæ PermissionService - Permissions: " + customRolePermissions.get(role));

        // Simuler une sauvegarde r√©ussie
        return true;
    }

    // M√©thode pour r√©initialiser aux permissions initiales depuis la base de donn√©es
    public RolePermissionsDto resetToInitialPermissions(String role) {
        System.out.println("üîÑ PermissionService - R√©initialisation aux permissions initiales pour le r√¥le " + role);
        
        try {
            // R√©cup√©rer l'ID du r√¥le
            Long roleId = permissionRepository.findRoleIdByName(role);
            
            if (roleId == null) {
                throw new IllegalArgumentException("R√¥le non trouv√©: " + role);
            }

            // D√©sactiver toutes les permissions actuelles pour ce r√¥le
            permissionRepository.deactivateAllPermissionsForRole(roleId);
            
            // R√©cup√©rer les permissions initiales depuis la base de donn√©es
            List<String> initialPermissions = getInitialPermissionsFromDatabase(role);
            
            // Activer les permissions initiales
            for (String permissionName : initialPermissions) {
                // R√©cup√©rer l'ID de la permission
                Long permissionId = permissionRepository.findPermissionIdByName(permissionName);
                
                if (permissionId != null) {
                    // V√©rifier si la relation existe d√©j√†
                    int count = permissionRepository.countRolePermissionRelation(roleId, permissionId);
                    
                    if (count > 0) {
                        // Mettre √† jour la relation existante
                        permissionRepository.activateRolePermissionRelation(roleId, permissionId);
                    } else {
                        // Cr√©er une nouvelle relation
                        permissionRepository.createRolePermissionRelation(roleId, permissionId);
                    }
                }
            }
            
            // Supprimer les permissions personnalis√©es du cache
            customRolePermissions.remove(role);
            
            System.out.println("üîÑ PermissionService - Permissions initiales restaur√©es pour le r√¥le " + role + " en base de donn√©es: " + initialPermissions);
            
            return new RolePermissionsDto(role, initialPermissions, true);
            
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©initialisation aux permissions initiales: " + e.getMessage());
            throw new RuntimeException("Erreur lors de la r√©initialisation aux permissions initiales: " + e.getMessage(), e);
        }
    }

    // M√©thode pour r√©cup√©rer les permissions initiales depuis la base de donn√©es
    private List<String> getInitialPermissionsFromDatabase(String role) {
        try {
            return permissionRepository.findPermissionsByRoleName(role);
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration des permissions initiales: " + e.getMessage());
            return getDefaultPermissionsForRole(role);
        }
    }

    // M√©thode pour v√©rifier si un utilisateur a une permission sp√©cifique
    public boolean checkUserPermission(String userId, String permission) {
        try {
            String userRole = getUserRoleFromDatabase(userId);
            List<String> userPermissions = getUserPermissions(userRole);
            return userPermissions.contains(permission);
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la v√©rification de la permission: " + e.getMessage());
            return false;
        }
    }

    // M√©thode pour r√©cup√©rer le r√¥le d'un utilisateur depuis la base de donn√©es
    private String getUserRoleFromDatabase(String userId) {
        try {
            // TODO: Utiliser un repository UserRepository au lieu du SQL direct
            // Pour l'instant, on retourne un r√¥le par d√©faut
            return "HOST";
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration du r√¥le de l'utilisateur: " + e.getMessage());
            // Fallback vers un r√¥le par d√©faut
            return "HOST";
        }
    }
}
