package com.clenzy.service;

import com.clenzy.dto.RolePermissionsDto;
import org.springframework.stereotype.Service;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;

import java.util.*;

@Service
public class PermissionService {

    // Permissions personnalis√©es par r√¥le (stock√©es en m√©moire pour l'instant)
    private final Map<String, List<String>> customRolePermissions;

    public PermissionService() {
        // Initialiser les permissions personnalis√©es vides
        customRolePermissions = new HashMap<>();
    }

    @Cacheable("roles")
    public List<String> getAllRoles() {
        return Arrays.asList("ADMIN", "MANAGER", "SUPERVISOR", "TECHNICIAN", "HOUSEKEEPER", "HOST");
    }

    @Cacheable("rolePermissions")
    public RolePermissionsDto getRolePermissions(String role) {
        try {
            List<String> permissions = getUserPermissions(role);
            boolean isDefault = !customRolePermissions.containsKey(role);
            return new RolePermissionsDto(role, permissions, isDefault);
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la r√©cup√©ration des permissions du r√¥le " + role + ": " + e.getMessage());
            throw new IllegalArgumentException("R√¥le non reconnu: " + role);
        }
    }

    @CacheEvict(value = {"rolePermissions", "userPermissions"}, allEntries = true)
    public RolePermissionsDto updateRolePermissions(String role, List<String> permissions) {
        // Valider que toutes les permissions existent
        List<String> allValidPermissions = getAllValidPermissions();
        for (String permission : permissions) {
            if (!allValidPermissions.contains(permission)) {
                throw new IllegalArgumentException("Permission non reconnue: " + permission);
            }
        }

        // Sauvegarder les permissions personnalis√©es en m√©moire
        customRolePermissions.put(role, new ArrayList<>(permissions));

        System.out.println("üîß PermissionService - Permissions mises √† jour pour le r√¥le " + role + ": " + permissions);

        return new RolePermissionsDto(role, permissions, false);
    }

    @CacheEvict(value = {"rolePermissions", "userPermissions"}, allEntries = true)
    public RolePermissionsDto resetRolePermissions(String role) {
        // Supprimer les permissions personnalis√©es
        customRolePermissions.remove(role);

        System.out.println("üîÑ PermissionService - Permissions r√©initialis√©es pour le r√¥le " + role);

        List<String> defaultPermissions = getUserPermissions(role);
        return new RolePermissionsDto(role, defaultPermissions, true);
    }

    public Map<String, List<String>> getDefaultPermissions() {
        Map<String, List<String>> result = new HashMap<>();
        List<String> roles = getAllRoles();

        for (String role : roles) {
            result.put(role, getUserPermissions(role));
        }

        return result;
    }

    public List<String> getAllValidPermissions() {
        return Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit", "properties:delete",
            "service-requests:view", "service-requests:create", "service-requests:edit", "service-requests:delete",
            "interventions:view", "interventions:create", "interventions:edit", "interventions:delete",
            "teams:view", "teams:create", "teams:edit", "teams:delete",
            "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:delete", "portfolios:manage_clients", "portfolios:manage_team",
            "contact:view", "contact:send", "contact:manage",
            "settings:view", "settings:edit",
            "users:manage",
            "reports:view"
        );
    }

    // M√©thode pour obtenir les permissions d'un utilisateur selon son r√¥le
    public List<String> getUserPermissions(String role) {
        // Si des permissions personnalis√©es existent, les utiliser
        if (customRolePermissions.containsKey(role)) {
            return customRolePermissions.get(role);
        }
        
        // Sinon, utiliser les permissions par d√©faut
        return getDefaultPermissionsForRole(role);
    }

    // M√©thode de fallback pour les permissions par d√©faut
    private List<String> getDefaultPermissionsForRole(String role) {
        Map<String, List<String>> defaultPermissions = new HashMap<>();

        defaultPermissions.put("ADMIN", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit", "properties:delete",
            "service-requests:view", "service-requests:create", "service-requests:edit", "service-requests:delete",
            "interventions:view", "interventions:create", "interventions:edit", "interventions:delete",
            "teams:view", "teams:create", "teams:edit", "teams:delete",
            "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:delete", "portfolios:manage_clients", "portfolios:manage_team",
            "contact:view", "contact:send", "contact:manage",
            "settings:view", "settings:edit",
            "users:manage",
            "reports:view"
        ));

        defaultPermissions.put("MANAGER", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit",
            "service-requests:view", "service-requests:create", "service-requests:edit",
            "interventions:view", "interventions:create", "interventions:edit",
            "teams:view", "teams:create", "teams:edit",
            "portfolios:view", "portfolios:create", "portfolios:edit", "portfolios:manage_clients", "portfolios:manage_team",
            "contact:view", "contact:send", "contact:manage",
            "settings:view",
            "users:view",
            "reports:view"
        ));

        defaultPermissions.put("SUPERVISOR", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view", "teams:edit",
            "portfolios:view",
            "contact:view", "contact:send"
        ));

        defaultPermissions.put("HOST", Arrays.asList(
            "dashboard:view",
            "properties:view", "properties:create", "properties:edit",
            "service-requests:view", "service-requests:create",
            "interventions:view",
            "contact:view", "contact:send"
        ));

        defaultPermissions.put("TECHNICIAN", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view",
            "contact:view", "contact:send"
        ));

        defaultPermissions.put("HOUSEKEEPER", Arrays.asList(
            "dashboard:view",
            "interventions:view", "interventions:edit",
            "teams:view",
            "contact:view", "contact:send"
        ));

        return defaultPermissions.getOrDefault(role, new ArrayList<>());
    }

    // M√©thode pour sauvegarder les permissions personnalis√©es d'un r√¥le
    public boolean saveRolePermissions(String role) {
        // V√©rifier s'il y a des permissions personnalis√©es √† sauvegarder
        if (!customRolePermissions.containsKey(role)) {
            System.out.println("üîß PermissionService - Aucune permission personnalis√©e √† sauvegarder pour le r√¥le " + role);
            return false;
        }

        // Pour l'instant, on simule la sauvegarde
        System.out.println("üíæ PermissionService - Sauvegarde des permissions personnalis√©es pour le r√¥le " + role);
        System.out.println("üíæ PermissionService - Permissions: " + customRolePermissions.get(role));

        // Simuler une sauvegarde r√©ussie
        return true;
    }

    // M√©thode pour r√©initialiser aux permissions initiales
    public RolePermissionsDto resetToInitialPermissions(String role) {
        System.out.println("üîÑ PermissionService - R√©initialisation aux permissions initiales pour le r√¥le " + role);

        // R√©cup√©rer les permissions initiales
        List<String> initialPermissions = getDefaultPermissionsForRole(role);

        // Supprimer les permissions personnalis√©es
        customRolePermissions.remove(role);

        // Retourner les permissions initiales
        return new RolePermissionsDto(role, initialPermissions, true);
    }

    // M√©thode pour v√©rifier si un utilisateur a une permission sp√©cifique
    public boolean checkUserPermission(String userId, String permission) {
        try {
            // Pour l'instant, on retourne toujours true
            // TODO: Impl√©menter la logique r√©elle avec la base de donn√©es
            System.out.println("‚ö†Ô∏è PermissionService.checkUserPermission() - M√©thode temporaire, retourne toujours true");
            return true;
        } catch (Exception e) {
            System.err.println("‚ùå PermissionService - Erreur lors de la v√©rification de la permission: " + e.getMessage());
            return false;
        }
    }
}